<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>coda db: coda_db</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">coda db
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">coda_db </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a href="https://travis-ci.org/ryjen/db"></a> <a href="https://coveralls.io/github/ryjen/db?branch=master"></a> <a href="https://www.gnu.org/licenses/gpl-3.0.en.html"></a> <a href="https://www.codacy.com/app/ryjen/coda_db/dashboard"></a> <a href="https://beerpay.io/ryjen/db"></a></p>
<p>a sqlite, mysql and postgres api with active record (ish) implementation.</p>
<h2>Building </h2>
<p>After cloning run the following command to initialize submodules:</p>
<div class="fragment"><div class="line">git submodule update --init --recursive</div></div><!-- fragment --><p><a href="https://www.docker.com">Docker</a> builds are available, docker-compose will run the tests with mysql and postgres images:</p>
<div class="fragment"><div class="line">{c++}</div><div class="line">docker-compose run test</div></div><!-- fragment --><p>otherwise use <a href="https://cmake.org">cmake</a> to generate for the build system of your choice, including Xcode.</p>
<div class="fragment"><div class="line">cmake -G Xcode .</div><div class="line">open coda_db.xcodeproj</div></div><!-- fragment --><p>options supported are:</p>
<div class="fragment"><div class="line">-DENABLE_COVERAGE=OFF            : enable code coverage using lcov</div><div class="line">-DENABLE_MEMCHECK=OFF            : enable valgrind memory checking on tests</div><div class="line">-DENABLE_PROFILING=OFF           : enable valgrind profiling on tests</div><div class="line">-DENABLE_PARAMETER_MAPPING=OFF   : use regex to map different parameter syntaxes</div><div class="line">-DENABLE_BENCHMARKING=OFF        : benchmark with other database libraries</div></div><!-- fragment --><h2>Debugging </h2>
<p>Debugging on docker can be done with docker compose:</p>
<div class="fragment"><div class="line">docker-compose run test gdb /usr/src/docker-build/tests/coda_db_test_xxx</div></div><!-- fragment --><h2>Documentation </h2>
<p>The complete API documentation is available at <a href="https://ryjen.github.io/db">https://ryjen.github.io/db</a></p>
<p>View some <a href="https://github.com/ryjen/db/wiki/Model">diagrams here</a>. These need to be improved.</p>
<h1>Records </h1>
<h2>An user object example </h2>
<p>For the purposes of this readme there is a global session variable:</p>
<div class="fragment"><div class="line">{c++}</div><div class="line">std::shared_ptr&lt;coda::db::session&gt; current_session = coda::db::create_session(&quot;file://test.db&quot;);</div><div class="line"></div><div class="line">/* Other databases:</div><div class="line"></div><div class="line">current_session = coda::db::create_session(&quot;mysql://user@pass:localhost:3306/database&quot;);</div><div class="line">current_session = coda::db::create_session(&quot;postgres://localhost/test&quot;);</div><div class="line"></div><div class="line">*/</div></div><!-- fragment --><p>Record objects should be implemented using the <a href="https://en.wikipedia.org/wiki/Curiously_recurring_template_pattern">curiously re-occuring template pattern (CRTP)</a>.</p>
<div class="fragment"><div class="line">{c++}</div><div class="line"></div><div class="line">class user : public coda::db::record&lt;user&gt;</div><div class="line">{</div><div class="line">public:</div><div class="line">    constexpr static const char *const TABLE_NAME = &quot;users&quot;;</div><div class="line"></div><div class="line">    /* only required constructor */</div><div class="line">    user(const std::shared_ptr&lt;schema&gt; &amp;schema) : record(schema)</div><div class="line">    {}</div><div class="line"></div><div class="line">    /* default constructor that gets the schema from the session */</div><div class="line">    user(const std::shared_ptr&lt;session&gt; &amp;session = current_session) </div><div class="line">          : record(session-&gt;get_schema(TABLE_NAME))</div><div class="line">    {}</div><div class="line"></div><div class="line">    /* utility method showing how to get columns */</div><div class="line">    string to_string() const</div><div class="line">    {</div><div class="line">        ostringstream buf;</div><div class="line">        buf &lt;&lt; id() &lt;&lt; &quot;: &quot; &lt;&lt; get(&quot;first_name&quot;) &lt;&lt; &quot; &quot; &lt;&lt; get(&quot;last_name&quot;);</div><div class="line">        return buf.str();</div><div class="line">    }</div><div class="line"></div><div class="line">    // optional overridden method to do custom initialization</div><div class="line">    void on_record_init(const coda::db::row &amp;row) {</div><div class="line">        set(&quot;customValue&quot;, row.column(&quot;customName&quot;).to_value());</div><div class="line">    }</div><div class="line"></div><div class="line">    // custom find method using the schema functions</div><div class="line">    vector&lt;shared_ptr&lt;user&gt;&gt; find_by_first_name(const string &amp;value) {</div><div class="line">        return coda::db::find_by&lt;user&gt;(this-&gt;schema(), &quot;first_name&quot;, value);</div><div class="line">    }</div><div class="line">};</div></div><!-- fragment --><h2>Save a record </h2>
<div class="fragment"><div class="line">{c++}</div><div class="line">/* save a user */</div><div class="line">user obj;</div><div class="line"></div><div class="line">obj.set(&quot;first_name&quot;, &quot;John&quot;);</div><div class="line">obj.set(&quot;last_name&quot;, &quot;Doe&quot;);</div><div class="line"></div><div class="line">if(!obj.save()) {</div><div class="line">    cerr &lt;&lt; current_session.last_error() &lt;&lt; endl;</div><div class="line">}</div></div><!-- fragment --><h2>Delete a record </h2>
<div class="fragment"><div class="line">{c++}</div><div class="line">user obj;</div><div class="line"></div><div class="line">obj.set_id(1);</div><div class="line"></div><div class="line">if(!obj.remove()) {</div><div class="line">    cerr &lt;&lt; current_session.last_error() &lt;&lt; endl;</div><div class="line">}</div></div><!-- fragment --><h2>Query a record </h2>
<div class="fragment"><div class="line">{c++}</div><div class="line">/* find users with a callback */</div><div class="line">user().find_by_id(1234, [](const shared_ptr&lt;user&gt; &amp;record) {</div><div class="line">    cout &lt;&lt; &quot;User: &quot; &lt;&lt; record-&gt;to_string() &lt;&lt; endl;</div><div class="line">});</div><div class="line"></div><div class="line">/* find users returning the results */</div><div class="line">auto results = user().find_all();</div><div class="line"></div><div class="line">for (auto &amp;user : results) {</div><div class="line">    cout &lt;&lt; &quot;User: &quot; &lt;&lt; record-&gt;to_string() &lt;&lt; endl;</div><div class="line">}</div></div><!-- fragment --><h2>Querying Schemas </h2>
<p>The library includes the following "schema functions" for querying with a schema objects:</p>
<ul>
<li><b>find_by_id()</b></li>
<li><b>find_all()</b></li>
<li><b>find_by()</b></li>
<li><b>find_one()</b></li>
</ul>
<p>These functions can:</p>
<ul>
<li>be generic column/values or specify type</li>
<li>return results in a collection or use callback</li>
</ul>
<p>example using a <em>callback</em> for a specific <em>user record</em>: </p><div class="fragment"><div class="line">{c++}</div><div class="line">auto schema = current_session-&gt;get_schema(user::TABLE_NAME);</div><div class="line"></div><div class="line">find_by_id&lt;user&gt;(schema, 1234, [](const shared_ptr&lt;user&gt; &amp;record) {</div><div class="line">    cout &lt;&lt; &quot;User: &quot; &lt;&lt; record-&gt;to_string() &lt;&lt; endl;</div><div class="line">});</div></div><!-- fragment --><p>example using a <em>return value</em> for a <em>generic record</em>:</p>
<div class="fragment"><div class="line">{c++}</div><div class="line">auto results = find_all(schema);</div><div class="line"></div><div class="line">for (auto record : results) {</div><div class="line">    cout &lt;&lt; &quot;Obj: &quot; &lt;&lt; record-&gt;to_string() &lt;&lt; endl;</div><div class="line">}</div></div><!-- fragment --><h1>Basic Queries </h1>
<h2>Modify Queries </h2>
<div class="fragment"><div class="line">{c++}</div><div class="line">/* insert a  user (INSERT INTO ...) */</div><div class="line">insert_query insert(current_session);</div><div class="line"></div><div class="line">/* insert column values into a table */</div><div class="line">insert.into(&quot;users&quot;).columns(&quot;id&quot;, &quot;first_name&quot;, &quot;last_name&quot;)</div><div class="line">            .values(4321, &quot;dave&quot;, &quot;patterson&quot;);</div><div class="line"></div><div class="line">if (!query.execute()) {</div><div class="line">    cerr &lt;&lt; current_session.last_error() &lt;&lt; endl;</div><div class="line">} else {</div><div class="line">    cout &lt;&lt; &quot;last insert id &quot; &lt;&lt; query.last_insert_id() &lt;&lt; endl;</div><div class="line">}</div></div><!-- fragment --><div class="fragment"><div class="line">{c++}</div><div class="line">/* update a user (UPDATE ...) */</div><div class="line">update_query update(current_session);</div><div class="line"></div><div class="line">/* update columns in a table with values */</div><div class="line">update.table(&quot;users&quot;).columns(&quot;id&quot;, &quot;first_name&quot;, &quot;last_name&quot;)</div><div class="line">         .values(3432, &quot;mark&quot;, &quot;anthony&quot;);</div><div class="line"></div><div class="line">/* using where clause with named parameters */</div><div class="line">query.where(op::equals(&quot;id&quot;, 1234)) or op::equals(&quot;last_name&quot;, &quot;henry&quot;);</div><div class="line"></div><div class="line">query.execute();</div></div><!-- fragment --><div class="fragment"><div class="line">{c++}</div><div class="line">/* delete a user (DELETE FROM ...) */</div><div class="line">delete_query query(current_session);</div><div class="line"></div><div class="line">query.from(&quot;users&quot;).where(equals(&quot;id&quot;, 1234)) and equals(&quot;first_name&quot;, &quot;bob&quot;);</div><div class="line"></div><div class="line">query.execute();</div></div><!-- fragment --><h2>Select Query </h2>
<div class="fragment"><div class="line">{c++}</div><div class="line">/* select some users */</div><div class="line">select_query query(current_session);</div><div class="line"></div><div class="line">query.from(&quot;users&quot;).where(equals(&quot;last_name&quot;, &quot;Jenkins&quot;)) or equals(&quot;first_name&quot;, &quot;Harry&quot;);</div><div class="line"></div><div class="line">auto results = query.execute();</div><div class="line"></div><div class="line">for ( auto &amp;row : results) {</div><div class="line">    string lName = row[&quot;last_name&quot;];</div><div class="line">    // do more stuff</div><div class="line">}</div></div><!-- fragment --><p>The select query also supports a call back interface:</p>
<div class="fragment"><div class="line">{c++}</div><div class="line">select_query query(current_session);</div><div class="line"></div><div class="line">query.from(&quot;users&quot;).execute([](const resultset &amp; rs)</div><div class="line">{</div><div class="line">    // do something with a resultset</div><div class="line"></div><div class="line">    rs.each([](const row &amp; r)</div><div class="line">    {</div><div class="line">        // do something with a row</div><div class="line"></div><div class="line">        r.each([](const column &amp; c)</div><div class="line">        {</div><div class="line">                // do something with a column</div><div class="line">        });</div><div class="line">    });</div><div class="line">});</div><div class="line"></div><div class="line">// use a function for a callback</div><div class="line">std::function&lt;void (const resultset &amp;)&gt; handler = [](const resultset &amp;results)</div><div class="line">{</div><div class="line">    printf(&quot;found %d results&quot;, results.size());</div><div class="line">}</div><div class="line"></div><div class="line">query.execute(handler);</div></div><!-- fragment --><h2>Joins </h2>
<p>The <b>join_clause</b> is used to build join statements.</p>
<div class="fragment"><div class="line">{c++}</div><div class="line">select_query select(current_session);</div><div class="line"></div><div class="line">select.columns(&quot;u.id&quot;, &quot;s.setting&quot;).from(&quot;users u&quot;)</div><div class="line">    .join(&quot;user_settings s&quot;).on(&quot;u.id = s.user_id&quot;) and (&quot;s.valid = 1&quot;);</div><div class="line"></div><div class="line">select.execute();</div></div><!-- fragment --><h2>Raw Queries </h2>
<p>Perform raw queries on a session object if you have to:</p>
<div class="fragment"><div class="line">{c++}</div><div class="line">auto results = session-&gt;query(&quot;select * from users&quot;);</div><div class="line"></div><div class="line">if (!session-&gt;execute(&quot;insert into users values(...)&quot;)) {</div><div class="line">    cerr &lt;&lt; session-&gt;last_error() &lt;&lt; endl;</div><div class="line">}</div></div><!-- fragment --> <h1>Transactions </h1>
<p>Transactions can be performed on a session object.</p>
<div class="fragment"><div class="line">{c++}</div><div class="line">...</div><div class="line">{</div><div class="line">    auto tx = current_session-&gt;start_transaction();</div><div class="line"></div><div class="line">    /* perform operations here */</div><div class="line"></div><div class="line">    tx-&gt;save(&quot;savepoint&quot;);</div><div class="line"></div><div class="line">    /* more operations here */</div><div class="line"></div><div class="line">    tx-&gt;rollback(&quot;savepoint&quot;);</div><div class="line">    tx-&gt;release(&quot;savepoint&quot;);</div><div class="line"></div><div class="line">    // set successful to commit on destruct</div><div class="line">    tx-&gt;set_successful(true);</div><div class="line">}</div><div class="line">// tx will be commited here</div><div class="line">...</div></div><!-- fragment --><h1>Prepared Statements </h1>
<h4>Parameters</h4>
<p>By default the library will use the prepared statement syntax of the database being used. This is the most efficient use.</p>
<hr/>
<h6>**ENHANCED_PARAMENTER_MAPPING (experimental feature)**</h6>
<p>If you compile with this flag, then the following syntaxes are managed by the library.</p>
<ul>
<li><b>$1, $2</b>, etc :<ul>
<li>indexed parameter</li>
</ul>
</li>
<li><b>?</b> :<ul>
<li>ordered index parameter (the first ? is equivalent to $1 and so on)</li>
</ul>
</li>
<li>** </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
